<!DOCTYPE html>
<html lang="en" ng-app="doc_app">
<head>
    <meta charset="UTF-8">
    <title>Doctor's Appointments</title>
    <link rel="stylesheet" href="/stylesheets/style.css">
    <script src="//ajax.googleapis.com/ajax/libs/angularjs/1.3.5/angular.min.js"></script>
    <script src="//ajax.googleapis.com/ajax/libs/angularjs/1.3.5/angular-route.min.js"></script>
    <script>
        var doc_app = angular.module('doc_app', ['ngRoute']);
        //setting up routing
            doc_app.config(function($routeProvider){
                $routeProvider
                    .when('/new_appointment', {
                        templateUrl: 'partials/new_appointment.html'
                    })
                    .when('/', {
                        templateUrl: 'partials/appts.html'
                    })
                    .otherwise({
                        redirectTo: '/'
                    });
            });
        
        doc_app.factory('ApptFactory', function($http){
            var factory = {};
            var appointments = [];
            factory.getAppt = function(callback){
                $http.get('/appointments').success(function(output){
                    appointments = output;
                    callback(appointments);
                });
            }
            factory.addAppt = function(appointment, callback){
                $http.post('/add_appt', appointment).success(function(data){
                    callback(data);
                });
            }
            return factory;
        });
        
        doc_app.factory('PatientFactory', function($http){
            var factory = {};
            var patients = [];
            factory.getPatient = function(callback){
                $http.get('/patients').success(function(output){
                    patients = output;
                    callback(patients);
                });
            }
            factory.addPatient = function(patient, callback){
                $http.post('/add_patient', patient).success(function(data){
                    callback(data);
                });
            }
            return factory;
        });
        
        doc_app.controller('ApptController', function($scope, ApptFactory){
            ApptFactory.getAppt(function(data){
                $scope.appointments = data;   
            });
            $scope.addAppt = function(){
                ApptFactory.addAppt($scope.new_appt, function(res){
                    $scope.appointments = res.results;
                });
                $scope.new_appt = {};
            }
        });
        
        doc_app.controller('PatientController', function($scope, PatientFactory){
            PatientFactory.getPatient(function(data){
                $scope.patients = data;
            });            
            window.onload = function(){
                $scope.patient_name = prompt('Your Name: ');
                if($scope.patient_name === null || $scope.patient_name.length === 0){
                    alert('You must enter a valid name!');
                    $scope.patient_name = prompt('Your Name: ');
                } else{
                    PatientFactory.addPatient({name: $scope.patient_name}, function(res){
                        $scope.patients = res.results;
                        if(res.error){
                            alert(res.error);
                        } else{
                            $scope.cust_id = res[0]._id;
                            console.log(res[0]._id);
                        }
                    });
                }
            }
        });
    </script>
</head>
<body ng-controller="ApptController">
    <div id="indent" ng-view="" ng-controller="PatientController"></div>
</body>
</html>